<!DOCTYPE html>
<html lang="en" style="height:100%;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>View Post - Plant Talk</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../frontend/css/pages/main.css">
    <link rel="stylesheet" href="../frontend/css/pages/shared.css">
    <link rel="stylesheet" href="../frontend/css/pages/post.css">
</head>

<body class="d-flex flex-column" style="min-height:100vh;">

    <!-- Shared Header -->
    <div id="shared-header"></div>

    <!-- Main Content -->
    <main class="container flex-grow-1 py-4">
        <!-- Loading State -->
        <div id="loading" class="text-center py-5">
            <div class="spinner-border loading-spinner" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-white">Loading post...</p>
        </div>

        <!-- Error State -->
        <div id="error-container" class="d-none">
            <div class="error-message text-center">
                <h4>Post Not Found</h4>
                <p>The post you're looking for doesn't exist or has been removed.</p>
                <a href="/" class="btn btn-outline-light">Back to Home</a>
            </div>
        </div>

        <!-- Post Content -->
        <div id="post-container" class="d-none">
            <div class="row">
                <!-- Main Post Content -->
                    <div class="post-content p-4">
                        <!-- Post Header -->
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <h1 id="post-title" class="h3 text-white mb-2"></h1>
                                <div class="author-info">
                                    <span>by <strong id="post-author"></strong></span>
                                    <span class="ms-2" id="post-time"></span>
                                </div>
                                <div id="post-tags" class="mt-2"></div>
                            </div>

                        </div>

                        <!-- Post Image -->
                        <div id="post-image-container" class="mb-3 d-none">
                            <div class="text-center">
                                <img id="post-image" class="post-image" alt="Post image" onclick="showImageModal(this.src)"
                                    style="cursor: pointer;">
                            </div>
                        </div>

                        <!-- Post Content -->
                        <div id="post-content" class="text-white mb-3"></div>

                        <!-- Post Actions -->
                        <div class="d-flex justify-content-between align-items-center border-top pt-3">
                            <div class="d-flex align-items-center gap-3">
                                <button id="share-btn" class="btn btn-outline-light btn-sm">
                                    <i class="bi bi-share"></i> Share
                                </button>
                                <span class="text-muted">
                                    <i class="bi bi-chat"></i> <span id="comment-count">0</span> comments
                                </span>
                                    <button id="like-btn" class="vote-btn" onclick="votePost(1)">
                                        <i class="bi bi-hand-thumbs-up"></i>
                                    </button>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-white"></span>
                                        <span id="like-count" class="fw-bold text-white fs-5">0</span>
                                    </div>
                                    <button id="dislike-btn" class="vote-btn" onclick="votePost(-1)">
                                        <i class="bi bi-hand-thumbs-down"></i>
                                    </button>
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-white"></span>
                                        <span id="dislike-count" class="fw-bold text-white fs-5">0</span>
                                    </div>
                                    
                            </div>
                            <a href="/" class="btn btn-outline-light btn-sm">
                                <i class="bi bi-arrow-left"></i> Back to Posts
                            </a>
                        </div>
                    </div>
                </div>


            <!-- Comments Section -->
            <div class="comment-section p-4 mt-4">
                <h4 class="text-white mb-3">
                    <i class="bi bi-chat-left-text"></i> Comments
                </h4>

                <!-- Comment Form (Only for logged-in users) -->
                <div id="comment-form-container" class="d-none">
                    <div class="comment-form">
                        <form id="comment-form">
                            <div class="mb-3">
                                <label for="comment-text" class="form-label text-white">Add a comment</label>
                                <textarea id="comment-text" class="form-control" rows="3"
                                    placeholder="Share your thoughts..." required></textarea>
                            </div>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Be respectful and constructive in your comments.</small>
                                <button type="submit" class="btn btn-outline-light">
                                    <i class="bi bi-send"></i> Post Comment
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Login Prompt for Non-logged Users -->
                <div id="login-prompt" class="text-center py-3 d-none">
                    <p class="text-muted">
                        <a href="/login" class="text-white">Login</a> or
                        <a href="/register" class="text-white">register</a> to join the discussion
                    </p>
                </div>

                <!-- Comments List -->
                <div id="comments-container">
                    <div id="comments-loading" class="text-center py-3">
                        <div class="spinner-border loading-spinner" role="status">
                            <span class="visually-hidden">Loading comments...</span>
                        </div>
                    </div>
                    <div id="comments-list"></div>
                    <div id="no-comments" class="text-center py-3 text-muted d-none">
                        <i class="bi bi-chat-square-dots fs-1"></i>
                        <p class="mt-2">No comments yet. Be the first to share your thoughts!</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Post Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="modalImage" src="" alt="Full size image" class="img-fluid">
                </div>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Share Post</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="share-url" class="form-label">Post URL</label>
                        <div class="input-group">
                            <input type="text" id="share-url" class="form-control" readonly>
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Edit Modal -->
    <div class="modal fade" id="editPostModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content"
                style="background-color: rgba(227, 227, 227, 0.482); backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 class="modal-title text-white">Edit Post</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Categories Selection -->
                    <div class="mb-3">
                        <label class="form-label text-white">Choose Categories</label>
                        <div class="category-selection">
                            <div class="category-bubbles" id="editCategoryBubbles">
                                <!-- Categories will be loaded here -->
                                <div class="text-center w-100">
                                    <div class="spinner-border spinner-border-sm text-light" role="status">
                                        <span class="visually-hidden">Loading categories...</span>
                                    </div>
                                </div>
                            </div>
    
                            <div class="selected-categories mt-2" id="editSelectedCategories">
                                <!-- Selected categories will appear here -->
                            </div>
    
                            <div class="category-help-text mt-2"
                                style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">
                                <i class="bi bi-info-circle me-1"></i>
                                Click on categories to select them. You can choose multiple categories for your post.
                            </div>
                        </div>
                    </div>
    
                    <!-- Title -->
                    <div class="mb-3">
                        <label for="edit-post-title" class="form-label text-white">Title</label>
                        <input type="text" id="edit-post-title" class="form-control"
                            style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white;">
                    </div>
    
                    <!-- Content -->
                    <div class="mb-3">
                        <label for="edit-post-content" class="form-label text-white">Content</label>
                        <textarea id="edit-post-content" class="form-control" rows="6"
                            style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white;"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-light" id="save-post-btn" disabled>Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Post Delete Modal -->
    <div class="modal fade" id="deletePostModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background-color: rgba(227, 227, 227, 0.482); backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 class="modal-title text-white">Delete Post</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-white">Are you sure you want to delete this post? This action cannot be undone.</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-danger" id="confirm-delete-post-btn">Delete Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Comment Edit Modal -->
    <div class="modal fade" id="editCommentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background-color: rgba(227, 227, 227, 0.482); backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 class="modal-title text-white">Edit Comment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="edit-comment-text" class="form-control" rows="4"
                        style="background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white;"
                        placeholder="Edit your comment..."></textarea>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-light" id="save-comment-btn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Comment Delete Modal -->
    <div class="modal fade" id="deleteCommentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="background-color: rgba(227, 227, 227, 0.482); backdrop-filter: blur(6px); border: 1px solid rgba(255, 255, 255, 0.2);">
                <div class="modal-header" style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                    <h5 class="modal-title text-white">Delete Comment</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-white">Are you sure you want to delete this comment? This action cannot be undone.</p>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-outline-danger" id="confirm-delete-comment-btn">Delete
                        Comment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shared footer -->
    <div id="shared-footer"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Load shared partials -->
    <script>
        // Load header based on authentication status
    async function loadHeaderBasedOnAuth() {
            try {
                // First check authentication status
                const authResponse = await fetch('/api/auth/status');
                const authData = await authResponse.json();
                const isLoggedIn = authData.loggedIn;

                // Load appropriate header
                let headerFile = isLoggedIn ?
                    '/frontend/templates/shared/header-signed.html' :
                    '/frontend/templates/shared/header.html';

                const headerResponse = await fetch(headerFile);
                const html = await headerResponse.text();
                document.getElementById('shared-header').innerHTML = html;

                // If signed in, update notifications and profile image
                if (isLoggedIn) {
                    setTimeout(() => {
                        // Update notifications
                        fetch('/api/notifications/count')
                            .then(response => response.json())
                            .then(data => {
                                const dot = document.getElementById('notification-dot');
                                if (dot) {
                                    dot.style.display = data.count > 0 ? 'block' : 'none';
                                }
                            })
                            .catch(error => console.error('🔔 Notification error:', error));

                        // Update profile image 
                        fetch('/api/user/profile')
                            .then(response => {
                                if (response.ok) {
                                    return response.json();
                                }
                                throw new Error(`HTTP ${response.status}`);
                            })
                            .then(data => {
                                const headerImg = document.getElementById('header-profile-image');
                                if (headerImg && data.profileImage && data.profileImage.trim() !== '') {
                                    console.log('👤 Setting header image to:', data.profileImage);
                                    headerImg.src = data.profileImage;
                                    headerImg.onerror = function () {
                                        console.log('👤 Image failed to load, using default');
                                        this.src = '/frontend/css/images/avatar.png';
                                    };
                                } else {
                                    console.log('👤 No profile image found or element missing');
                                }
                            })
                            .catch(error => console.error('👤 Profile image error:', error));
                    }, 300);
                }
            } catch (error) {
                // Fallback to unsigned header
                fetch('/frontend/templates/shared/header.html')
                    .then(r => r.text())
                    .then(html => document.getElementById('shared-header').innerHTML = html)
                    .catch(fallbackError => console.error('❌ Fallback header error:', fallbackError));
            }
        }

        // Call the function
        loadHeaderBasedOnAuth();


        // Load footer
        fetch('/frontend/templates/shared/footer.html').then(r => r.text())
            .then(html => document.getElementById('shared-footer').innerHTML = html);
    </script>

    <script>
        let currentPost = null;
        let currentPostId = null;
        let isLoggedIn = false;
        let currentUserId = null;
        let currentEditingCommentId = null;
        let editAllCategories = [];
        let editSelectedCategories = new Set();

        // Get post ID from URL
        function getPostIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // Load post data
        async function loadPost() {
            const postId = getPostIdFromUrl();
            if (!postId) {
                showError();
                return;
            }

            currentPostId = postId;

            try {
                const response = await fetch(`/api/post?id=${postId}`);
                if (!response.ok) {
                    throw new Error('Post not found');
                }

                const post = await response.json();
                displayPost(post);
                loadComments();

                // Hide loading, show post
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('post-container').classList.remove('d-none');

            } catch (error) {
                console.error('Error loading post:', error);
                showError();
            }
        }

        // Display post data
        function displayPost(post) {
            currentPost = post;

            document.getElementById('post-title').textContent = post.title;
            document.getElementById('post-author').textContent = post.author;
            document.getElementById('post-time').textContent = post.timeAgo;
            document.getElementById('post-content').innerHTML = post.content.replace(/\n/g, '<br>');
            document.getElementById('like-count').textContent = post.likes || 0;
            document.getElementById('dislike-count').textContent = post.dislikes || 0;
            document.getElementById('comment-count').textContent = post.comments || 0;

            // Display tags
            const tagsContainer = document.getElementById('post-tags');
            if (post.tags && post.tags.length > 0) {
                tagsContainer.innerHTML = post.tags.map(tag =>
                    `<span class="tag-badge">#${tag}</span>`
                ).join('');
            }

            // Display image if available
            if (post.imageUrl) {
                const imageContainer = document.getElementById('post-image-container');
                const imageElement = document.getElementById('post-image');
                imageElement.src = post.imageUrl;
                imageContainer.classList.remove('d-none');
            }

            // Add edit/delete buttons if user is the author
            if (isLoggedIn && post.isAuthor) {
                addPostActionButtons();
            }

            // Update vote buttons
            updateVoteButtons(post.userVote || 0);

            // Update page title
            document.title = `${post.title} - Plant Talk`;

            // Set share URL
            document.getElementById('share-url').value = window.location.href;
        }

        // Add post action buttons
            function addPostActionButtons() {
                const postHeader = document.querySelector('.post-content .d-flex.justify-content-between');
                if (postHeader && !document.getElementById('post-actions-dropdown')) {
                    const actionsHTML = `
            <div class="dropdown" id="post-actions-dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <button class="dropdown-item" onclick="editCurrentPost()">
                            <i class="bi bi-pencil me-2"></i>Edit Post
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item text-danger" onclick="deleteCurrentPost()">
                            <i class="bi bi-trash me-2"></i>Delete Post
                        </button>
                    </li>
                </ul>
            </div>
        `;
                    postHeader.insertAdjacentHTML('beforeend', actionsHTML);
                }
            }

            // Edit current post
            function editCurrentPost() {
                    if (!currentPost) return;

                    // Reset selected categories
                    editSelectedCategories.clear();

                    // Pre-populate form fields
                    document.getElementById('edit-post-title').value = currentPost.title;
                    document.getElementById('edit-post-content').value = currentPost.content;

                    // Load categories and show modal
                    loadEditCategories().then(() => {
                        const modal = new bootstrap.Modal(document.getElementById('editPostModal'));
                        modal.show();
                    });
                }


                async function loadEditCategories() {
                        try {
                            const response = await fetch('/api/categories');
                            const categories = await response.json();
                            editAllCategories = categories;

                            // Pre-select current post categories
                            if (currentPost && currentPost.tags) {
                                currentPost.tags.forEach(tag => editSelectedCategories.add(tag));
                            }

                            renderEditCategories();
                            updateEditCategoryDisplay();
                            validateEditForm();
                        } catch (error) {
                            console.error('Error loading categories for edit:', error);
                            document.getElementById('editCategoryBubbles').innerHTML =
                                '<div class="text-danger">Failed to load categories</div>';
                        }
                    }

                    // Render category bubbles for edit modal
                    function renderEditCategories() {
                        const container = document.getElementById('editCategoryBubbles');
                        container.innerHTML = '';

                        editAllCategories.forEach(category => {
                            const isSelected = editSelectedCategories.has(category.name);
                            const bubble = document.createElement('div');
                            bubble.className = `category-bubble ${isSelected ? 'selected' : ''}`;
                            bubble.dataset.categoryName = category.name;
                            bubble.innerHTML = `
            <span class="category-name">${category.name}</span>
            <i class="bi ${isSelected ? 'bi-check-circle' : 'bi-plus-circle'} ms-1"></i>
        `;
                            bubble.addEventListener('click', () => toggleEditCategory(category.name));
                            container.appendChild(bubble);
                        });
                    }

                    // Toggle category selection for edit modal
                    function toggleEditCategory(categoryName) {
                        if (editSelectedCategories.has(categoryName)) {
                            editSelectedCategories.delete(categoryName);
                        } else {
                            editSelectedCategories.add(categoryName);
                        }

                        updateEditCategoryDisplay();
                        validateEditForm();
                    }

                    // Update visual display of categories for edit modal
                    function updateEditCategoryDisplay() {
                        // Update bubbles
                        document.querySelectorAll('#editCategoryBubbles .category-bubble').forEach(bubble => {
                            const categoryName = bubble.dataset.categoryName;
                            const icon = bubble.querySelector('i');

                            if (editSelectedCategories.has(categoryName)) {
                                bubble.classList.add('selected');
                                icon.className = 'bi bi-check-circle ms-1';
                            } else {
                                bubble.classList.remove('selected');
                                icon.className = 'bi bi-plus-circle ms-1';
                            }
                        });

                        // Update selected categories display
                        const selectedContainer = document.getElementById('editSelectedCategories');
                        selectedContainer.innerHTML = '';

                        if (editSelectedCategories.size === 0) {
                            selectedContainer.innerHTML = '<div class="category-help-text" style="color: rgba(255, 255, 255, 0.7);">No categories selected</div>';
                            return;
                        }

                        editSelectedCategories.forEach(categoryName => {
                            const tag = document.createElement('div');
                            tag.className = 'selected-category-tag';
                            tag.innerHTML = `
            <span>#${categoryName}</span>
            <i class="bi bi-x remove-btn" onclick="removeEditCategory('${categoryName}')"></i>
        `;
                            selectedContainer.appendChild(tag);
                        });
                    }

                    // Remove category from selection in edit modal
                    function removeEditCategory(categoryName) {
                        editSelectedCategories.delete(categoryName);
                        updateEditCategoryDisplay();
                        validateEditForm();
                    }

                    // Validate edit form
                    function validateEditForm() {
                        const title = document.getElementById('edit-post-title').value.trim();
                        const content = document.getElementById('edit-post-content').value.trim();
                        const hasCategories = editSelectedCategories.size > 0;

                        const saveBtn = document.getElementById('save-post-btn');
                        saveBtn.disabled = !(title && content && hasCategories);
                    }

            // Delete current post
            function deleteCurrentPost() {
                if (!currentPost) return;

                const modal = new bootstrap.Modal(document.getElementById('deletePostModal'));
                modal.show();
            }

            // Edit post API call
            async function editPost(title, content) {
                    try {
                        // Create form data with categories
                        const formData = new FormData();
                        formData.append('post_id', currentPostId);
                        formData.append('title', title);
                        formData.append('content', content);

                        // Add categories
                        editSelectedCategories.forEach(category => {
                            formData.append('categories[]', category);
                        });

                        const response = await fetch('/api/posts/edit', {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            // Update the current display
                            currentPost.title = title;
                            currentPost.content = content;
                            currentPost.tags = Array.from(editSelectedCategories);

                            document.getElementById('post-title').textContent = title;
                            document.getElementById('post-content').innerHTML = content.replace(/\n/g, '<br>');

                            // Update tags display
                            const tagsContainer = document.getElementById('post-tags');
                            if (currentPost.tags && currentPost.tags.length > 0) {
                                tagsContainer.innerHTML = currentPost.tags.map(tag =>
                                    `<span class="tag-badge">#${tag}</span>`
                                ).join('');
                            } else {
                                tagsContainer.innerHTML = '';
                            }

                            showSuccessMessage('Post updated successfully!');
                        } else {
                            showErrorMessage('Failed to edit post');
                        }
                    } catch (error) {
                        console.error('Error editing post:', error);
                        showErrorMessage('Error editing post');
                    }
                }

            // Delete post API call
            async function deletePost() {
                try {
                    const response = await fetch('/api/posts/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `post_id=${currentPostId}`
                    });

                    if (response.ok) {
                        showSuccessMessage('Post deleted successfully!');
                        setTimeout(() => {
                            window.location.href = '/'; // Redirect to home
                        }, 1500);
                    } else {
                        showErrorMessage('Failed to delete post');
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                    showErrorMessage('Error deleting post');
                }
            }

            // Display comments with edit/delete dropdowns
            function displayComments(comments) {
                const commentsList = document.getElementById('comments-list');

                const commentCount = comments ? comments.length : 0;
                const commentText = commentCount === 1 ? 'Comment' : 'Comments';

                const commentsHeader = document.querySelector('.comment-section h4');
                if (commentsHeader) {
                    commentsHeader.innerHTML = `<i class="bi bi-chat-left-text"></i> ${commentCount} ${commentText}`;
                }

                if (!comments || comments.length === 0) {
                    document.getElementById('no-comments').classList.remove('d-none');
                    return;
                }

                commentsList.innerHTML = comments.map(comment => {
                    // Check if current user is the comment author
                    const isCommentAuthor = isLoggedIn && comment.isAuthor;

                    const actionsDropdown = isCommentAuthor ? `
            <div class="dropdown">
                <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" 
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                        <button class="dropdown-item" onclick="editComment(${comment.id}, '${comment.content.replace(/'/g, "\\'")}')">
                            <i class="bi bi-pencil me-2"></i>Edit Comment
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item text-danger" onclick="deleteComment(${comment.id})">
                            <i class="bi bi-trash me-2"></i>Delete Comment
                        </button>
                    </li>
                </ul>
            </div>
        ` : '';

                    return `
            <div class="comment-item p-3" id="comment-${comment.id}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <strong class="text-white">${comment.author}</strong>
                            <small class="text-muted ms-2">${comment.timeAgo}</small>
                        </div>
                        <p class="text-white mb-2" id="comment-content-${comment.id}">${comment.content.replace(/\n/g, '<br>')}</p>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-light vote-comment-btn ${comment.userVote === 1 ? 'active-like' : ''}" 
                                onclick="voteComment(${comment.id}, 1)">
                                <i class="bi bi-hand-thumbs-up"></i> 
                            </button>
                            <span class="vote-count like-count">${comment.likeCount || 0}</span>
                            <button class="btn btn-sm btn-outline-light vote-comment-btn ${comment.userVote === -1 ? 'active-dislike' : ''}" 
                                onclick="voteComment(${comment.id}, -1)">
                                <i class="bi bi-hand-thumbs-down"></i> 
                            </button>
                            <span class="vote-count like-count">${comment.dislikeCount || 0}</span>
                        </div>
                    </div>
                    ${actionsDropdown}
                </div>
            </div>
        `;
                }).join('');
            }

            // Edit comment function
            function editComment(commentId, currentContent) {
                currentEditingCommentId = commentId;
                document.getElementById('edit-comment-text').value = currentContent;
                const modal = new bootstrap.Modal(document.getElementById('editCommentModal'));
                modal.show();
            }

            // Edit comment API call
            async function editCommentAPI(commentId, content) {
                try {
                    const response = await fetch('/api/comments/edit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `comment_id=${commentId}&content=${encodeURIComponent(content)}`
                    });

                    if (response.ok) {
                        // Update the comment display
                        document.getElementById(`comment-content-${commentId}`).innerHTML = content.replace(/\n/g, '<br>');
                        showSuccessMessage('Comment updated successfully!');
                    } else {
                        showErrorMessage('Failed to edit comment');
                    }
                } catch (error) {
                    console.error('Error editing comment:', error);
                    showErrorMessage('Error editing comment');
                }
            }

            // Delete comment function
            function deleteComment(commentId) {
                    currentEditingCommentId = commentId;
                    const modal = new bootstrap.Modal(document.getElementById('deleteCommentModal'));
                    modal.show();
                }


                // Delete comment API call
                    async function deleteCommentAPI(commentId) {
                        try {
                            const response = await fetch('/api/comments/delete', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `comment_id=${commentId}`
                            });

                            if (response.ok) {
                                // Remove comment from display
                                document.getElementById(`comment-${commentId}`).remove();

                                // Update comment count
                                const currentCount = parseInt(document.getElementById('comment-count').textContent);
                                document.getElementById('comment-count').textContent = Math.max(0, currentCount - 1);

                                showSuccessMessage('Comment deleted successfully!');
                            } else {
                                showErrorMessage('Failed to delete comment');
                            }
                        } catch (error) {
                            console.error('Error deleting comment:', error);
                            showErrorMessage('Error deleting comment');
                        }
                    }

                     // Show success message
                        function showSuccessMessage(message) {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
                            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; background-color: rgba(40, 167, 69, 0.9); border: none; color: white;';
                            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            `;
                            document.body.appendChild(alertDiv);

                            setTimeout(() => {
                                if (alertDiv.parentNode) {
                                    alertDiv.parentNode.removeChild(alertDiv);
                                }
                            }, 3000);
                        }

                        // Show error message
                        function showErrorMessage(message) {
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                            alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; background-color: rgba(220, 53, 69, 0.9); border: none; color: white;';
                            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            `;
                            document.body.appendChild(alertDiv);

                            setTimeout(() => {
                                if (alertDiv.parentNode) {
                                    alertDiv.parentNode.removeChild(alertDiv);
                                }
                            }, 3000);
                        }

        // Load comments
        async function loadComments() {
            try {
                document.getElementById('comments-loading').classList.remove('d-none');

                const response = await fetch(`/api/comments?post_id=${currentPostId}`);
                const comments = await response.json();

                document.getElementById('comments-loading').classList.add('d-none');
                displayComments(comments);

            } catch (error) {
                console.error('Error loading comments:', error);
                document.getElementById('comments-loading').classList.add('d-none');
                document.getElementById('no-comments').classList.remove('d-none');
            }
        }

        // Vote on post
        async function votePost(vote) {
            if (!isLoggedIn) {
                alert('Please login to like/dislike posts');
                return;
            }

            try {
                const response = await fetch('/api/posts/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `post_id=${currentPostId}&vote=${vote}`
                });

                if (!response.ok) {
                    throw new Error('Failed to like/dislike post');
                }

                const result = await response.json();
                if (result.success) {
                    document.getElementById('like-count').textContent = result.likeCount;
                    document.getElementById('dislike-count').textContent = result.dislikeCount;
                    updateVoteButtons(result.userVote);
                } else {
                    throw new Error('Like/Dislike failed');
                }

            } catch (error) {
                console.error('Error voting on post:', error);
                alert('Failed to like/dislike. Please try again.');
            }
        }

        // Vote on comment
        async function voteComment(commentId, vote) {
            if (!isLoggedIn) {
                alert('Please login to like/dislike comments');
                return;
            }

            try {
                const response = await fetch('/api/comments/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `comment_id=${commentId}&vote=${vote}`
                });

                const result = await response.json();
                if (result.success) {
                    // Reload comments to update counts
                    loadComments();
                }

            } catch (error) {
                console.error('Error liking/disliking comment:', error);
            }
        }

        // Update vote button states
        function updateVoteButtons(userVote) {
            const likeBtn = document.getElementById('like-btn');
            const dislikeBtn = document.getElementById('dislike-btn');

            // Reset classes
            likeBtn.classList.remove('active-like');
            dislikeBtn.classList.remove('active-dislike');

            // Set active state
            if (userVote === 1) {
                likeBtn.classList.add('active-like');
            } else if (userVote === -1) {
                dislikeBtn.classList.add('active-dislike');
            }
        }

        // Submit comment
        async function submitComment(event) {
            event.preventDefault();

            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) return;

            try {
                const response = await fetch('/api/comments/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `post_id=${currentPostId}&content=${encodeURIComponent(commentText)}`
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('comment-text').value = '';
                    loadComments();

                    // Update comment count
                    const currentCount = parseInt(document.getElementById('comment-count').textContent);
                    document.getElementById('comment-count').textContent = currentCount + 1;
                }

            } catch (error) {
                console.error('Error submitting comment:', error);
                alert('Error submitting comment. Please try again.');
            }
        }

        // Show image modal
        function showImageModal(imageUrl) {
            document.getElementById('modalImage').src = imageUrl;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        // Copy URL to clipboard
        function copyToClipboard() {
            const shareUrl = document.getElementById('share-url');
            shareUrl.select();
            shareUrl.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(shareUrl.value);

            // Show feedback
            const button = event.target.closest('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i> Copied!';
            setTimeout(() => {
                button.innerHTML = originalText;
            }, 2000);
        }

        // Show error state
        function showError() {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error-container').classList.remove('d-none');
        }

        // Check authentication status
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status');
                const data = await response.json();
                isLoggedIn = data.loggedIn;
                currentUserId = data.userID;

                if (isLoggedIn) {
                    document.getElementById('comment-form-container').classList.remove('d-none');
                } else {
                    document.getElementById('login-prompt').classList.remove('d-none');
                }

            } catch (error) {
                console.error('Error checking auth status:', error);
                document.getElementById('login-prompt').classList.remove('d-none');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthStatus();
            loadPost();

            // Setup comment form
            document.getElementById('comment-form').addEventListener('submit', submitComment);

            document.getElementById('edit-post-title').addEventListener('input', validateEditForm);
            document.getElementById('edit-post-content').addEventListener('input', validateEditForm);


            // Setup share button
            document.getElementById('share-btn').addEventListener('click', () => {
                const modal = new bootstrap.Modal(document.getElementById('shareModal'));
                modal.show();
            });
        // Modal event listeners
            // Comment modal handlers
            document.getElementById('save-comment-btn').addEventListener('click', async () => {
                if (currentEditingCommentId) {
                    const newContent = document.getElementById('edit-comment-text').value.trim();
                    if (newContent) {
                        await editCommentAPI(currentEditingCommentId, newContent);
                        bootstrap.Modal.getInstance(document.getElementById('editCommentModal')).hide();
                    }
                }
            });

            document.getElementById('confirm-delete-comment-btn').addEventListener('click', async () => {
                if (currentEditingCommentId) {
                    await deleteCommentAPI(currentEditingCommentId);
                    bootstrap.Modal.getInstance(document.getElementById('deleteCommentModal')).hide();
                }
            });

            // Post modal handlers
            document.getElementById('save-post-btn').addEventListener('click', async () => {
                const newTitle = document.getElementById('edit-post-title').value.trim();
                const newContent = document.getElementById('edit-post-content').value.trim();

                if (!newTitle || !newContent || editSelectedCategories.size === 0) {
                    alert('Please fill in all fields and select at least one category.');
                    return;
                }

                await editPost(newTitle, newContent);
                bootstrap.Modal.getInstance(document.getElementById('editPostModal')).hide();
            });

            document.getElementById('confirm-delete-post-btn').addEventListener('click', async () => {
                await deletePost();
                bootstrap.Modal.getInstance(document.getElementById('deletePostModal')).hide();
            });
        });
        </script>
</body>

</html>